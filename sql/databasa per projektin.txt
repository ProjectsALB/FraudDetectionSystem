-- ==========================
-- FRAUD DETECTION DATABASE
-- ==========================

-- 1. USERS
CREATE TABLE Users (
    user_id SERIAL PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(20),
    date_of_birth DATE,
    country VARCHAR(50),
    kyc_status BOOLEAN DEFAULT FALSE,
    risk_level INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL
);

-- 2. ROLES
CREATE TABLE Roles (
    role_id SERIAL PRIMARY KEY,
    role_name VARCHAR(50) UNIQUE NOT NULL
);

-- 3. USER_ROLES
CREATE TABLE User_Roles (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    role_id INT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES Users(user_id),
    FOREIGN KEY (role_id) REFERENCES Roles(role_id)
);

-- 4. ACCOUNTS
CREATE TABLE Accounts (
    account_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    iban VARCHAR(34) UNIQUE NOT NULL,
    balance DECIMAL(18,2) DEFAULT 0,
    currency CHAR(3) DEFAULT 'EUR',
    account_type VARCHAR(20) DEFAULT 'STANDARD',
    status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES Users(user_id)
);

-- 5. DEVICES
CREATE TABLE Devices (
    device_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    device_fingerprint VARCHAR(100) UNIQUE,
    os VARCHAR(50),
    browser VARCHAR(50),
    first_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    trusted BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (user_id) REFERENCES Users(user_id)
);

-- 6. LOGIN_HISTORY
CREATE TABLE Login_History (
    login_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    device_id INT,
    ip_address VARCHAR(45),
    geo_lat DECIMAL(10,6),
    geo_long DECIMAL(10,6),
    country VARCHAR(50),
    city VARCHAR(50),
    login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    success BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (user_id) REFERENCES Users(user_id),
    FOREIGN KEY (device_id) REFERENCES Devices(device_id)
);

-- 7. MERCHANTS
CREATE TABLE Merchants (
    merchant_id SERIAL PRIMARY KEY,
    merchant_name VARCHAR(100) NOT NULL,
    category VARCHAR(50),
    country VARCHAR(50),
    risk_score INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 8. TRANSACTIONS
CREATE TABLE Transactions (
    transaction_id SERIAL PRIMARY KEY,
    account_id INT NOT NULL,
    merchant_id INT NOT NULL,
    device_id INT,
    amount DECIMAL(18,2) NOT NULL,
    currency CHAR(3) DEFAULT 'EUR',
    transaction_type VARCHAR(50) DEFAULT 'PAYMENT',
    geo_location VARCHAR(100),
    ip_address VARCHAR(45),
    transaction_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'SUCCESS',
    risk_score INT DEFAULT 0,
    ml_score DECIMAL(5,2),
    FOREIGN KEY (account_id) REFERENCES Accounts(account_id),
    FOREIGN KEY (merchant_id) REFERENCES Merchants(merchant_id),
    FOREIGN KEY (device_id) REFERENCES Devices(device_id)
);

-- 9. FRAUD_RULES
CREATE TABLE Fraud_Rules (
    rule_id SERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL,
    description TEXT,
    threshold_value DECIMAL(18,2),
    weight INT DEFAULT 1,
    active BOOLEAN DEFAULT TRUE
);

-- 10. FRAUD_ALERTS
CREATE TABLE Fraud_Alerts (
    alert_id SERIAL PRIMARY KEY,
    transaction_id INT NOT NULL,
    rule_id INT,
    risk_score INT DEFAULT 0,
    severity VARCHAR(20) DEFAULT 'MEDIUM',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved BOOLEAN DEFAULT FALSE,
    analyst_id INT,
    FOREIGN KEY (transaction_id) REFERENCES Transactions(transaction_id),
    FOREIGN KEY (rule_id) REFERENCES Fraud_Rules(rule_id),
    FOREIGN KEY (analyst_id) REFERENCES Users(user_id)
);

-- 11. BLACKLIST
CREATE TABLE Blacklist (
    blacklist_id SERIAL PRIMARY KEY,
    type VARCHAR(20) NOT NULL,
    value VARCHAR(100) NOT NULL,
    reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 12. WHITELIST
CREATE TABLE Whitelist (
    whitelist_id SERIAL PRIMARY KEY,
    user_id INT,
    merchant_id INT,
    reason TEXT,
    FOREIGN KEY (user_id) REFERENCES Users(user_id),
    FOREIGN KEY (merchant_id) REFERENCES Merchants(merchant_id)
);

-- 13. BEHAVIOR_PROFILE
CREATE TABLE Behavior_Profile (
    profile_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    avg_transaction_amount DECIMAL(18,2),
    avg_daily_transactions DECIMAL(5,2),
    common_country VARCHAR(50),
    usual_login_hour INT,
    risk_pattern_score INT DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES Users(user_id)
);

-- 14. AUDIT_LOGS
CREATE TABLE Audit_Logs (
    log_id SERIAL PRIMARY KEY,
    table_name VARCHAR(50) NOT NULL,
    record_id INT NOT NULL,
    action VARCHAR(20) NOT NULL,
    old_value TEXT,
    new_value TEXT,
    changed_by INT,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (changed_by) REFERENCES Users(user_id)
);

-- 15. ML_PREDICTIONS
CREATE TABLE ML_Predictions (
    prediction_id SERIAL PRIMARY KEY,
    transaction_id INT NOT NULL,
    model_version VARCHAR(20),
    probability DECIMAL(5,2),
    label VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (transaction_id) REFERENCES Transactions(transaction_id)
);      kam kete database shqyertoje dhe kur te jesh gati me thuaj